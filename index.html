<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>just for you</title>
  <style>
    :root{
      --bg1:#231b22;
      --bg2:#121a2a;
      --glass: rgba(255,255,255,.10);
      --glass2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.18);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --accent: #ff6fb1;
      --accent2:#ffd1e8;
      --shadow: 0 30px 90px rgba(0,0,0,.55);
      --radius: 28px;
    }
    *{box-sizing:border-box}

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans TC", sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 15%, rgba(255,111,177,.22), transparent 60%),
        radial-gradient(1000px 700px at 80% 25%, rgba(160,140,255,.18), transparent 60%),
        radial-gradient(1000px 900px at 50% 100%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
    }

    /* ËÉåÊôØÁ≤íÂ≠êÂ±§ */
    .bg{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:0;
      overflow:hidden;
    }
    .spark{
      position:absolute;
      width:6px; height:6px;
      border-radius:999px;
      background: rgba(255,255,255,.9);
      opacity:.55;
      animation: twinkle 2.8s ease-in-out infinite;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
    }
    @keyframes twinkle{
      0%,100%{transform:scale(.85); opacity:.35}
      50%{transform:scale(1.4); opacity:.85}
    }
    .heart{
      position:absolute;
      width:18px; height:18px;
      transform: rotate(45deg);
      background: rgba(255,140,190,.90);
      border-radius: 4px;
      opacity:.55;
      animation: floatUp linear infinite;
      filter: drop-shadow(0 18px 24px rgba(0,0,0,.25));
    }
    .heart:before,.heart:after{
      content:"";
      position:absolute;
      width:18px; height:18px;
      background: inherit;
      border-radius: 999px;
    }
    .heart:before{left:-9px; top:0}
    .heart:after{left:0; top:-9px}
    @keyframes floatUp{
      from{transform: translateY(120px) rotate(45deg); opacity:0}
      12%{opacity:.55}
      to{transform: translateY(-120vh) rotate(45deg); opacity:0}
    }

    /* ÂÖ©ÂºµÂúñ‰∫ÇË∑ëÂ±§ÔºàÂèØÈªûÔºâ */
    .playfield{
      position:fixed;
      inset:0;
      z-index:1;
      pointer-events:auto;
      overflow:hidden;
    }
    .runner{
      position:absolute;
      width:84px;
      height:auto;
      opacity:.95;
      cursor:pointer;
      user-select:none;
      filter: drop-shadow(0 22px 36px rgba(0,0,0,.42));
      transform: translate3d(0,0,0);
    }
    .runner.bob{animation: bob 1.15s ease-in-out infinite;}
    .paused .runner.bob{animation-play-state: paused;}
    @keyframes bob{
      0%,100%{transform: translateY(0)}
      50%{transform: translateY(-7px)}
    }
    .shake{animation: shake .25s ease-in-out 1;}
    @keyframes shake{
      0%,100%{transform: translateX(0)}
      25%{transform: translateX(-5px)}
      50%{transform: translateX(5px)}
      75%{transform: translateX(-4px)}
    }

    /* ‰∏ªÂç°Áâá */
    .wrap{
      width:min(560px, 100%);
      position:relative;
      z-index:2;
    }
    .card{
      position:relative;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-90px -80px auto auto;
      width:300px; height:300px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,111,177,.35), transparent 60%),
        radial-gradient(circle at 70% 70%, rgba(160,140,255,.25), transparent 60%);
      transform: rotate(18deg);
      pointer-events:none;
    }

    .topText{
      padding:18px 18px 8px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-size: 26px;
      letter-spacing:.6px;
      opacity:.95;
      font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", "Noto Sans TC", sans-serif;
    }
    .smallHeart{
      width:14px;height:14px;
      transform: rotate(45deg);
      background: rgba(255,140,190,.92);
      border-radius: 3px;
      position:relative;
      top:1px;
    }
    .smallHeart:before,.smallHeart:after{
      content:"";
      position:absolute;
      width:14px;height:14px;background:inherit;border-radius:999px;
    }
    .smallHeart:before{left:-7px; top:0}
    .smallHeart:after{left:0; top:-7px}

    /* Â∞ÅÈù¢ */
    .coverWrap{padding:8px 18px 14px; display:flex; justify-content:center;}
    .cover{
      width:min(420px, 100%);
      aspect-ratio: 1 / 1;
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(600px 400px at 50% 20%, rgba(255,255,255,.14), transparent 60%),
        radial-gradient(500px 500px at 50% 80%, rgba(255,111,177,.10), transparent 60%),
        rgba(0,0,0,.18);
      box-shadow: 0 22px 60px rgba(0,0,0,.45);
      overflow:hidden;
      position:relative;
    }
    .cover img{
      width:100%;
      height:100%;
      object-fit:contain;
      filter: drop-shadow(0 28px 55px rgba(0,0,0,.35));
    }

    /* Ê®ôÈ°å */
    .meta{
      padding: 0 18px 4px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-size: 34px;
      font-weight: 860;
      letter-spacing:.5px;
      text-shadow: 0 18px 50px rgba(0,0,0,.35);
    }
    .pinkHeart{color: rgba(255,140,190,.95); font-size: 28px; position:relative; top:2px;}

    /* Ë∑≥Â≠óË®äÊÅØ */
    .msg{
      padding: 0 18px 10px;
      display:flex;
      justify-content:center;
      color: var(--muted);
      font-size: 13.5px;
      min-height: 22px;
      text-align:center;
    }
    .popline{display:inline-block; white-space:pre-wrap}
    .ch{
      display:inline-block;
      transform: translateY(10px) scale(.98);
      opacity:0;
      filter: blur(1px);
      animation: pop .55s ease forwards;
    }
    @keyframes pop{
      to{transform: translateY(0) scale(1); opacity:1; filter: blur(0)}
    }

    /* ÈÄ≤Â∫¶Ê¢ù */
    .barRow{
      padding: 0 18px 12px;
      display:flex;
      align-items:center;
      gap:12px;
      color: rgba(255,255,255,.78);
      font-size: 14px;
    }
    .range{
      flex:1;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,.18);
      position:relative;
      overflow:hidden;
    }
    .fill{
      position:absolute; left:0; top:0; bottom:0;
      width:0%;
      background: linear-gradient(90deg, rgba(255,255,255,.85), rgba(255,140,190,.9));
    }
    input[type="range"]{
      width:100%;
      appearance:none;
      background: transparent;
      position:relative;
      z-index:2;
      height: 26px;
      margin:-10px 0;
    }
    input[type="range"]::-webkit-slider-thumb{
      appearance:none;
      width:16px; height:16px;
      border-radius:999px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.15);
      box-shadow: 0 10px 22px rgba(0,0,0,.30);
      cursor:pointer;
    }

    /* ÊéßÂà∂Âàó */
    .controls{
      padding: 0 18px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .iconBtn{
      width:44px; height:44px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,.85);
      cursor:pointer;
      user-select:none;
    }
    .playBtn{
      width:74px; height:74px;
      border-radius:999px;
      border:0;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.65), rgba(255,111,177,.95));
      box-shadow: 0 20px 50px rgba(255,111,177,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .playTri{
      width:0;height:0;
      border-left:18px solid rgba(255,255,255,.92);
      border-top:12px solid transparent;
      border-bottom:12px solid transparent;
      margin-left:4px;
    }
    .pauseBars{
      display:none;
      gap:8px;
    }
    .pauseBars span{
      width:8px; height:26px;
      border-radius:6px;
      background: rgba(255,255,255,.92);
      display:block;
    }
    .isPlaying .playTri{display:none;}
    .isPlaying .pauseBars{display:flex;}

    /* Â≠óÂπï */
    .capWrap{
      margin: 0 18px 18px;
      padding: 12px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
    }
    .capTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      color: rgba(255,255,255,.72);
      font-size: 12.5px;
      margin-bottom:8px;
    }
    .caps{
      min-height: 84px;
      font-size: 16px;
      line-height: 1.9;
      text-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .capLine{
      opacity:.40;
      transform: translateY(0);
      transition: opacity .12s ease, transform .12s ease;
      white-space:pre-wrap;
    }
    .capLine.active{
      opacity:1;
      transform: translateY(-1px);
    }
    .hint{
      padding: 0 18px 18px;
      text-align:center;
      font-size: 12.5px;
      color: rgba(255,255,255,.62);
    }
  </style>
</head>

<body>
  <!-- ËÉåÊôØÁ≤íÂ≠ê -->
  <div class="bg" id="bg"></div>

  <!-- ÂÖ©ÂºµÂúñ‰∫ÇË∑ë -->
  <div class="playfield" id="playfield">
    <img class="runner bob" id="r1" src="img/run1.png" alt="">
    <img class="runner bob" id="r2" src="img/run2.png" alt="">
  </div>

  <div class="wrap" id="wrap">
    <div class="card">
      <div class="topText">
        <span>ÂØ∂ÂØ∂ÊàëÊÑõ‰Ω†</span>
        <span class="smallHeart"></span>
      </div>

      <div class="coverWrap">
        <div class="cover">
          <img src="img/cover.png" alt="">
        </div>
      </div>

      <div class="meta">
        <span id="songTitle">Sweet Moment</span>
        <span class="pinkHeart">‚ô•</span>
      </div>

      <div class="msg" id="msg"></div>

      <div class="barRow">
        <span id="tNow">0:00</span>
        <div class="range">
          <div class="fill" id="fill"></div>
          <input id="seek" type="range" min="0" max="1000" value="0" />
        </div>
        <span id="tAll">0:00</span>
      </div>

      <div class="controls">
        <div class="iconBtn" id="muteBtn" title="ÈùúÈü≥/ÂèñÊ∂àÈùúÈü≥">üîà</div>

        <button class="playBtn" id="playBtn" title="Êí≠Êîæ/Êö´ÂÅú">
          <div class="playTri"></div>
          <div class="pauseBars"><span></span><span></span></div>
        </button>

        <div class="iconBtn" id="reloadBtn" title="ÈáçÊñ∞Âà§Êñ∑ÊôÇÈñì‰∏¶ËºâÂÖ•">‚ü≥</div>
      </div>

      <div class="capWrap" id="capWrap">
        <div class="capTop">
          <span>Â≠óÂπï</span>
          <span id="timeTag">00:00</span>
        </div>
        <div class="caps" id="caps"></div>
      </div>

      <div class="hint">ÂØ∂ÂØ∂Ë¶ÅÊåâÊí≠ÊîæÂñî!!</div>

      <!-- ÁúüÊ≠£Êí≠ÊîæÁî®ÁöÑ audioÔºàÈö±ËóèÔºâ -->
      <audio id="player" preload="auto"></audio>
    </div>
  </div>

<script>
  /** ====== 1) ‰Ω†ÂèØËá™Ë®ÇÔºöÊ≠åÂêç/Ë®äÊÅØ/Â≠óÂπï/Ë∑ØÂæë ====== */
  const CFG = {
    slots: {
      morning: {
        label: "Êó©‰∏ä",
        title: "ÂØ∂ÂØ∂Ëµ∑Â∫ä‰πãÊ≠å",
        message: "‰ªäÂ§©ÊÖ¢ÊÖ¢‰æÜÔºåÊàëÂú®‰Ω†Ë∫´ÈÇä„ÄÇ",
        song: "audio/Morning_song.mp3",
        captions: [
          { t: 10,  text: "Êó©‰∏äÁöÑÈ¢® Êúâ‰∏ÄÈªûÊ∂º" },
          { t: 15,  text: "Á™óÂ§ñÁöÑÂÖâ ÊÖ¢ÊÖ¢‰∫Æ" },
          { t: 20,  text: "‰∏çÁî®Â§™Âø´ ‰πü‰∏çÁî®Ë∂ï" },
          { t: 26,  text: "‰ªäÂ§©ÁöÑË∑Ø ÊÖ¢ÊÖ¢Ëµ∞ÂÆå" },
          { t: 31,  text: "Â¶ÇÊûúÂ¶≥Á¨ë ÈÇ£Â∞±ÂæàÂ•Ω" },
          { t: 38,  text: "ÊàëÂú®ÈÄôË£° Èô™Â¶≥Ëµ∑Â∫ä" }
        ]
      },
      day: {
        label: "ÁôΩÂ§©",
        title: "ÊàëÁöÑËá≠ÂØ∂ÂØ∂",
        message: "‰∏äÁè≠ÂæàËæõËã¶ÔºåËÉΩ‰∏äÂ∞±‰∏äÔºõÁÑ°ËÅäÂ∞±ÂêÉÂêÉÂñùÂñù„ÄÇÊúâÊàëÈô™‰Ω†„ÄÇ",
        song: "audio/day_song.mp3",
        captions: [
          { t: 10,  text: "‰∏äÁè≠ÂæàËæõËã¶" },
          { t: 12,  text: "ËÉΩÊíêÂ∞±Êíê" },
          { t: 14,  text: "‰∏çÊÉ≥ÊíêÁöÑÊôÇÂÄô ‰πüÊ≤íÈóú‰øÇ" },
          { t: 21,  text: "‰∫ãÊÉÖÂÅöÂÆå Â∞±ÂÖàÊîæËëó" },
          { t: 25,  text: "ÁÑ°ËÅäÁöÑË©± ÂêÉÂêÉÂñùÂñù" },
          { t: 31,  text: "‰∏çÁî®ÊÉ≥Â§™Â§ö ‰πü‰∏çÁî®ÊÄ•" },
          { t: 38,  text: "ÊúâÊàëÈô™‰Ω† ÊÖ¢ÊÖ¢ÈÅéÂéª" }
        ]
      },
      evening: {
        label: "Êôö‰∏ä",
        title: "Good Job Today",
        message: "ËæõËã¶‰∫ÜÔºå‰ªäÂ§©Â∞±Âà∞ÈÄôË£°„ÄÇ",
        song: "audio/night.mp3",
        captions: [
          { t: 0,  text: "‰ªäÂ§©ÂÅöÂæóÂæàÂ•Ω" },
          { t: 7,  text: "ÊääÁ¥ØÊîæ‰∏ã‰æÜ" },
          { t: 14, text: "‰Ω†Âè™Ë¶ÅË¢´ÊàëÂ•ΩÂ•ΩÈô™Ëëó" },
          { t: 20, text: "Â∞±Â§†‰∫Ü" }
        ]
      },
      night: {
        label: "Ê∑±Â§ú",
        title: "I‚Äôm Here",
        message: "Â¶ÇÊûú‰Ω†ÈÇÑÈÜíËëóÔºåÊàëÂú®„ÄÇ",
        song: "audio/midnight.mp3",
        captions: [
          { t: 0,  text: "Èù†ÈÅé‰æÜ‰∏ÄÈªûÔºåÊä±‰∏Ä‰∏ã/Hold me close, just for a while" },
          { t: 6,  text: "‰Ω†‰ªäÂ§©Â∑≤Á∂ìÂæàÂä™Âäõ‰∫Ü/You did your best today" },
          { t: 11, text: "‰∏çÁî®ÂÜçÂ•îË∑ëÔºå‰πü‰∏çÁî®ÂÜçÂæÆÁ¨ë/No need to run, no need to smile" },
          { t: 17, text: "Â∞±ËÆìÂÆâÈùúÁïôÂú®ÈÄôË£°/Let the quiet stay" },
          { t: 22, text: "Â¶ÇÊûú‰ªäÊôöÊÄùÁ∑íÂæàÂêµ/If your thoughts are loud tonight" },
          { t: 28, text: "ÊàëÊúÉ‰∏ÄÁõ¥Âú®/I‚Äôll stay right here" },
          { t: 33, text: "‰Ω†‰ªÄÈ∫ºÈÉΩ‰∏çÁî®Ë™™/You don‚Äôt have to say a word" },
          { t: 37, text: "ÊàëÂ∞±Âú®‰Ω†Ë∫´ÈÇä/I‚Äôm near" },
          { t: 40, text: "ÁîúÁîúÁöÑÂ§úÊôöÔºåÈñâ‰∏äÁúºÁùõ/Sweet night, close your eyes" },
          { t: 45, text: "ËÆì‰∏ñÁïåÊÖ¢ÊÖ¢ÈÅ†Âéª/Let the world drift away" },
          { t: 50, text: "ÊàëÂ∞±Âú®‰Ω†Ë∫´ÊóÅ/I‚Äôm right here by your side" },
          { t: 56, text: "‰Ω†ÂæàÂÆâÂÖ®Ôºå‰∏ÄÂàáÈÉΩÊúÉÂ•Ω/You‚Äôre safe, you‚Äôre okay" },
          { t: 70, text: "ÊÖ¢ÊÖ¢ÂëºÂê∏ÔºåÊää‰∏ÄÂàáÊîæ‰∏ã/Breathe in slow, let it go" },
          { t: 77, text: "ÊàëÊúÉÈô™‰Ω†Áõ¥Âà∞ÂÖ•Áù°/I‚Äôll be here till you sleep" },
          { t: 83, text: "ÊôöÂÆâÔºåÊàëÁöÑÊÑõ/Good night, my love" },
          { t: 90, text: "ÂÆâÂøÉ‰ºëÊÅØÂêß/Rest easy" },
        ]
      }
    }
  };

  /** ====== 2) Â∞èÂ∑•ÂÖ∑ÔºàÈò≤ÂëÜÔºâ ====== */
  const $ = (id)=>document.getElementById(id);
  const on = (el, ev, fn)=>{ if(el) el.addEventListener(ev, fn); };

  function pickSlotKey(){
    const h = new Date().getHours();
    if(h>=6 && h<11) return "morning";
    if(h>=11 && h<18) return "day";
    if(h>=18 && h<23) return "evening";
    return "night";
  }
  function fmt(sec){
    sec = Math.max(0, Math.floor(sec||0));
    const m = Math.floor(sec/60);
    const s = sec%60;
    return `${m}:${String(s).padStart(2,"0")}`;
  }
  function fmt2(sec){
    sec = Math.max(0, Math.floor(sec||0));
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
  }

  /** ====== 3) ËÉåÊôØÁ≤íÂ≠êÁîüÊàê ====== */
  const bg = $("bg");
  function spawnBackground(){
    if(!bg) return;
    for(let i=0;i<26;i++){
      const s=document.createElement("div");
      s.className="spark";
      s.style.left = (Math.random()*100)+"vw";
      s.style.top  = (Math.random()*100)+"vh";
      s.style.animationDelay = (Math.random()*2.8)+"s";
      s.style.opacity = (0.25 + Math.random()*0.6);
      const size = 3 + Math.random()*5;
      s.style.width = size+"px";
      s.style.height = size+"px";
      bg.appendChild(s);
    }
    for(let i=0;i<10;i++){
      const h=document.createElement("div");
      h.className="heart";
      h.style.left = (Math.random()*100)+"vw";
      h.style.bottom = (-40 - Math.random()*200)+"px";
      h.style.opacity = (0.20 + Math.random()*0.5);
      const scale = 0.6 + Math.random()*1.0;
      h.style.transform = `rotate(45deg) scale(${scale})`;
      const dur = 7 + Math.random()*9;
      h.style.animationDuration = dur+"s";
      h.style.animationDelay = (Math.random()*6)+"s";
      bg.appendChild(h);
    }
  }
  spawnBackground();

  /** ====== 4) DOM/ÁãÄÊÖã ====== */
  const wrap = $("wrap");
  const player = $("player");
  const playBtn = $("playBtn");
  const muteBtn = $("muteBtn");
  const reloadBtn = $("reloadBtn");
  const seek = $("seek");
  const fill = $("fill");
  const tNow = $("tNow");
  const tAll = $("tAll");
  const timeTag = $("timeTag");
  const songTitle = $("songTitle");
  const msgEl = $("msg");
  const capsEl = $("caps");
  const capWrap = $("capWrap");

  function showStatus(text){
    if(!msgEl) return;
    msgEl.innerHTML = `<span style="opacity:.9">${text}</span>`;
  }

  let slotKey = pickSlotKey();
  let slot = CFG.slots[slotKey];
  let duration = 0;
  let isSeeking = false;

  function animateText(el, text){
    if(!el) return;
    el.innerHTML = "";
    const span=document.createElement("span");
    span.className="popline";
    Array.from(text || "").forEach((c,i)=>{
      const s=document.createElement("span");
      s.className="ch";
      s.style.animationDelay = (i*0.03)+"s";
      s.textContent=c;
      span.appendChild(s);
    });
    el.appendChild(span);
  }

  function renderCaptions(captions){
    if(!capsEl) return;
    capsEl.innerHTML = "";
    (captions||[]).forEach((c,i)=>{
      const div=document.createElement("div");
      div.className="capLine";
      div.dataset.i=String(i);
      div.textContent=c.text;
      capsEl.appendChild(div);
    });
  }

  function activeIndex(captions, t){
    let a=-1;
    for(let i=0;i<captions.length;i++){
      if(t >= captions[i].t) a=i;
      else break;
    }
    return a;
  }

  /** ====== 5) ËºâÂÖ•/ÂàáÊ≠å ====== */
  function apply(key){
    slotKey = key;
    slot = CFG.slots[slotKey];

    if(songTitle) songTitle.textContent = slot.title || "Sweet Moment";
    animateText(msgEl, slot.message || "");

    if(player){
      player.pause();
      player.currentTime = 0;
      player.src = slot.song || "";
      player.load(); // ÈáçË¶ÅÔºöÊòéÁ¢∫ËºâÂÖ•
    }

    if(wrap) wrap.classList.remove("isPlaying");
    document.body.classList.add("paused");

    renderCaptions(slot.captions || []);
    if(timeTag) timeTag.textContent = "00:00";

    if(fill) fill.style.width = "0%";
    if(seek) seek.value = "0";
    if(tNow) tNow.textContent = "0:00";
    if(tAll) tAll.textContent = "0:00";
    duration = 0;

    showStatus(slot.message || "");
  }

  apply(slotKey);

  /** ====== 6) Êí≠Êîæ/Êö´ÂÅú + Èü≥Ë®äÂàÜÊûêÔºàÁØÄÂ•èË∑≥Ôºâ ====== */
  let audioCtx = null;
  let analyser = null;
  let data = null;
  let beat = 0;

  function ensureAnalyser(){
    if(!player) return;
    if(audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioCtx.createMediaElementSource(player);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 1024;
    data = new Uint8Array(analyser.fftSize);
    src.connect(analyser);
    analyser.connect(audioCtx.destination);
  }

  function updateBeat(){
    if(!analyser || !data) { beat = beat*0.85; return; }
    analyser.getByteTimeDomainData(data);
    let sum = 0;
    for(let i=0;i<data.length;i++){
      const v = (data[i]-128)/128;
      sum += v*v;
    }
    const rms = Math.sqrt(sum/data.length);
    beat = Math.min(1, beat*0.82 + rms*1.05);
  }

  async function togglePlay(){
    if(!player) return;
    try{
      ensureAnalyser();
      if(audioCtx && audioCtx.state === "suspended") await audioCtx.resume();

      if(player.paused){
        await player.play();
        if(wrap) wrap.classList.add("isPlaying");
        document.body.classList.remove("paused");
      }else{
        player.pause();
        if(wrap) wrap.classList.remove("isPlaying");
        document.body.classList.add("paused");
      }
    }catch(err){
      showStatus("Êí≠ÊîæÂ§±ÊïóÔºöË´ãÁ¢∫Ë™çÈü≥Ê™îË∑ØÂæë„ÄÅÊ™îÂêçÂ§ßÂ∞èÂØ´Ëàá‰º∫ÊúçÂô®ÊòØÂê¶ÂèØÂ≠òÂèñ„ÄÇ");
      console.error(err);
    }
  }

  on(playBtn, "click", togglePlay);

  if(player){
    player.addEventListener("play", ()=>{
      if(wrap) wrap.classList.add("isPlaying");
      document.body.classList.remove("paused");
    });
    player.addEventListener("pause", ()=>{
      if(wrap) wrap.classList.remove("isPlaying");
      document.body.classList.add("paused");
    });

    player.addEventListener("error", ()=>{
      showStatus("Èü≥Ê™îËºâÂÖ•Â§±ÊïóÔºöË´ãÊ™¢Êü• audio/ ÂÖßÊòØÂê¶ÁúüÁöÑÊúâË©≤ mp3Ôºå‰∏îÊ™îÂêçÂ§ßÂ∞èÂØ´‰∏ÄËá¥„ÄÇ");
    });

    player.addEventListener("loadedmetadata", ()=>{
      duration = player.duration || 0;
      if(tAll) tAll.textContent = fmt(duration);
    });
  }

  on(muteBtn, "click", ()=>{
    if(!player || !muteBtn) return;
    player.muted = !player.muted;
    muteBtn.textContent = player.muted ? "üîá" : "üîà";
  });

  on(reloadBtn, "click", ()=>apply(pickSlotKey()));

  /** ====== 7) ÈÄ≤Â∫¶Ê¢ùÔºàÂèØÊãñÊõ≥Ôºâ ====== */
  if(seek){
    seek.addEventListener("pointerdown", ()=>{ isSeeking=true; });
    seek.addEventListener("pointerup", ()=>{ isSeeking=false; });

    seek.addEventListener("input", ()=>{
      if(!duration || !fill) return;
      const p = Number(seek.value)/1000;
      fill.style.width = (p*100)+"%";
      if(isSeeking){
        const t = p*duration;
        if(tNow) tNow.textContent = fmt(t);
        if(timeTag) timeTag.textContent = fmt2(t);
      }
    });

    seek.addEventListener("change", ()=>{
      if(!duration || !player) return;
      const p = Number(seek.value)/1000;
      player.currentTime = p*duration;
    });
  }

  /** ====== 8) Â≠óÂπïÊõ¥Êñ∞ÔºàË∑üÈö®ÊôÇÈñìÔºâ ====== */
  let lastActive = -2;

  function updateCaptions(t){
    const caps = slot.captions || [];
    if(timeTag) timeTag.textContent = fmt2(t);

    if(!caps.length || !capsEl) return;

    const a = activeIndex(caps, t);
    const nodes = capsEl.querySelectorAll(".capLine");

    nodes.forEach((n,i)=>{
      n.classList.toggle("active", i===a);
      if(a === -1) n.style.display = (i < 4 ? "" : "none");
      else n.style.display = (Math.abs(i-a)<=2 ? "" : "none");
    });

    if(a !== lastActive){
      lastActive = a;
      attractToCaptionArea();
    }
  }

  /** ====== 9) ÂÖ©ÂºµÂúñ‰∫ÇË∑ëÔºàÈªûÊìäÂô¥ÊÑõÂøÉ + Â≠óÂπïÂê∏ÂºïÔºâ ====== */
  const r1 = $("r1");
  const r2 = $("r2");
  const capArea = $("capWrap");

  function makeRunner(el, seed){
    return {
      el,
      x: 70 + seed*90,
      y: 120 + seed*120,
      vx: (1.4 + Math.random()*1.6) * (Math.random()>.5?1:-1),
      vy: (1.2 + Math.random()*1.4) * (Math.random()>.5?1:-1),
      baseScale: 0.62 + Math.random()*0.10,
      lastSwitch: performance.now(),
      switchEvery: 1200 + Math.random()*1700,
      attractUntil: 0,
      attractX: 0,
      attractY: 0
    };
  }

  const R = [];
  if(r1) R.push(makeRunner(r1,1));
  if(r2) R.push(makeRunner(r2,2));

  // Âêà‰Ωµ flip Âà∞ transformÔºàÈÅøÂÖçË¢´Ë¶ÜËìãÔºâ
  function setRunnerTransform(s){
    if(!s.el) return;

    const playing = wrap && wrap.classList.contains("isPlaying");
    const pulse = playing ? (beat*0.18) : 0;
    const sc = s.baseScale * (1 + pulse);

    const dir = (s.vx < 0) ? -1 : 1; // Â∑¶Âè≥ÁøªËΩâ
    s.el.style.transform = `translate3d(${s.x}px, ${s.y}px, 0) scale(${dir*sc}, ${sc})`;
  }

  function burstHearts(x, y){
    if(!bg) return;
    const n = 10 + Math.floor(Math.random()*10);
    for(let i=0;i<n;i++){
      const h = document.createElement("div");
      h.className = "heart";
      h.style.left = (x + (Math.random()*60-30)) + "px";
      h.style.top  = (y + (Math.random()*60-30)) + "px";
      const scale = 0.45 + Math.random()*0.9;
      h.style.transform = `rotate(45deg) scale(${scale})`;
      const dur = 0.9 + Math.random()*1.2;
      h.style.animationDuration = dur+"s";
      h.style.animationDelay = "0s";
      h.style.opacity = 0.75;
      bg.appendChild(h);
      setTimeout(()=>h.remove(), 2200);
    }
  }

  function shake(el){
    if(!el) return;
    el.classList.remove("shake");
    void el.offsetWidth;
    el.classList.add("shake");
    setTimeout(()=>el.classList.remove("shake"), 280);
  }

  if(r1) r1.addEventListener("click", (e)=>{ shake(r1); burstHearts(e.clientX, e.clientY); });
  if(r2) r2.addEventListener("click", (e)=>{ shake(r2); burstHearts(e.clientX, e.clientY); });

  function attractToCaptionArea(){
    if(!capArea) return;
    const rect = capArea.getBoundingClientRect();
    const tx = rect.left + rect.width*0.35;
    const ty = rect.top  + rect.height*0.35;

    const now = performance.now();
    R.forEach((s, idx)=>{
      s.attractUntil = now + (700 + idx*180);
      s.attractX = tx + (idx===0 ? -70 : 70);
      s.attractY = ty + (idx===0 ? -10 : 15);
    });
  }
  setTimeout(attractToCaptionArea, 500);

  /** ====== 10) ‰∏ªÂæ™Áí∞ÔºàÈÄ≤Â∫¶ + Â≠óÂπï + Ë∑ëÂãïÔºâ ====== */
  function tick(now){
    updateBeat();

    const t = player ? (player.currentTime || 0) : 0;

    if(duration > 0){
      const p = Math.min(1, t/duration);
      if(!isSeeking && seek && fill){
        seek.value = String(Math.floor(p*1000));
        fill.style.width = (p*100)+"%";
        if(tNow) tNow.textContent = fmt(t);
      }
    }else{
      if(tNow) tNow.textContent = fmt(t);
    }

    updateCaptions(t);

    const playing = wrap && wrap.classList.contains("isPlaying");
    const w = window.innerWidth;
    const h = window.innerHeight;

    R.forEach((s)=>{
      if(playing && s.el){
        if(now - s.lastSwitch > s.switchEvery){
          s.vx += (Math.random()*1.2 - 0.6);
          s.vy += (Math.random()*1.0 - 0.5);
          s.vx = Math.max(-3.2, Math.min(3.2, s.vx));
          s.vy = Math.max(-3.0, Math.min(3.0, s.vy));
          s.lastSwitch = now;
          s.switchEvery = 1200 + Math.random()*1800;
        }

        if(now < s.attractUntil){
          const ax = s.attractX - s.x;
          const ay = s.attractY - s.y;
          s.vx += ax * 0.0006;
          s.vy += ay * 0.0006;
        }

        s.x += s.vx;
        s.y += s.vy;

        const rect = s.el.getBoundingClientRect();
        const rectW = rect.width;
        const rectH = rect.height;

        const minX = 10, minY = 10;
        const maxX = w - rectW - 10;
        const maxY = h - rectH - 10;

        if(s.x < minX){ s.x = minX; s.vx *= -1; }
        if(s.x > maxX){ s.x = maxX; s.vx *= -1; }
        if(s.y < minY){ s.y = minY; s.vy *= -1; }
        if(s.y > maxY){ s.y = maxY; s.vy *= -1; }
      }

      setRunnerTransform(s);
    });

    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
</script>

</body>
</html>
