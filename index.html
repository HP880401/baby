<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>just for you</title>
  <style>
    :root{
      --bg1:#231b22;
      --bg2:#121a2a;
      --glass: rgba(255,255,255,.10);
      --glass2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.18);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --accent: #ff6fb1;
      --accent2:#ffd1e8;
      --shadow: 0 30px 90px rgba(0,0,0,.55);
      --radius: 28px;
    }
    *{box-sizing:border-box}

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans TC", sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 15%, rgba(255,111,177,.22), transparent 60%),
        radial-gradient(1000px 700px at 80% 25%, rgba(160,140,255,.18), transparent 60%),
        radial-gradient(1000px 900px at 50% 100%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
    }

    /* èƒŒæ™¯ç²’å­å±¤ */
    .bg{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:0;
      overflow:hidden;
    }
    .spark{
      position:absolute;
      width:6px; height:6px;
      border-radius:999px;
      background: rgba(255,255,255,.9);
      opacity:.55;
      animation: twinkle 2.8s ease-in-out infinite;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
    }
    @keyframes twinkle{
      0%,100%{transform:scale(.85); opacity:.35}
      50%{transform:scale(1.4); opacity:.85}
    }
    .heart{
      position:absolute;
      width:18px; height:18px;
      transform: rotate(45deg);
      background: rgba(255,140,190,.90);
      border-radius: 4px;
      opacity:.55;
      animation: floatUp linear infinite;
      filter: drop-shadow(0 18px 24px rgba(0,0,0,.25));
    }
    .heart:before,.heart:after{
      content:"";
      position:absolute;
      width:18px; height:18px;
      background: inherit;
      border-radius: 999px;
    }
    .heart:before{left:-9px; top:0}
    .heart:after{left:0; top:-9px}
    @keyframes floatUp{
      from{transform: translateY(120px) rotate(45deg); opacity:0}
      12%{opacity:.55}
      to{transform: translateY(-120vh) rotate(45deg); opacity:0}
    }

    /* å…©å¼µåœ–äº‚è·‘å±¤ï¼ˆå¯é»ï¼‰ */
    .playfield{
      position:fixed;
      inset:0;
      z-index:1;
      pointer-events:auto;
      overflow:hidden;
    }
    .runner{
      position:absolute;
      width:84px;
      height:auto;
      opacity:.95;
      cursor:pointer;
      user-select:none;
      filter: drop-shadow(0 22px 36px rgba(0,0,0,.42));
      transform: translate3d(0,0,0);
    }
    .runner.flip{transform: scaleX(-1);}
    .runner.bob{animation: bob 1.15s ease-in-out infinite;}
    .paused .runner.bob{animation-play-state: paused;}
    @keyframes bob{
      0%,100%{transform: translateY(0)}
      50%{transform: translateY(-7px)}
    }
    .shake{animation: shake .25s ease-in-out 1;}
    @keyframes shake{
      0%,100%{transform: translateX(0)}
      25%{transform: translateX(-5px)}
      50%{transform: translateX(5px)}
      75%{transform: translateX(-4px)}
    }

    /* ä¸»å¡ç‰‡ */
    .wrap{
      width:min(560px, 100%);
      position:relative;
      z-index:2;
    }
    .card{
      position:relative;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-90px -80px auto auto;
      width:300px; height:300px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,111,177,.35), transparent 60%),
        radial-gradient(circle at 70% 70%, rgba(160,140,255,.25), transparent 60%);
      transform: rotate(18deg);
      pointer-events:none;
    }

    .topText{
      padding:18px 18px 8px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-size: 26px;
      letter-spacing:.6px;
      opacity:.95;
      font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", "Noto Sans TC", sans-serif;
    }
    .smallHeart{
      width:14px;height:14px;
      transform: rotate(45deg);
      background: rgba(255,140,190,.92);
      border-radius: 3px;
      position:relative;
      top:1px;
    }
    .smallHeart:before,.smallHeart:after{
      content:"";
      position:absolute;
      width:14px;height:14px;background:inherit;border-radius:999px;
    }
    .smallHeart:before{left:-7px; top:0}
    .smallHeart:after{left:0; top:-7px}

    /* å°é¢ */
    .coverWrap{padding:8px 18px 14px; display:flex; justify-content:center;}
    .cover{
      width:min(420px, 100%);
      aspect-ratio: 1 / 1;
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(600px 400px at 50% 20%, rgba(255,255,255,.14), transparent 60%),
        radial-gradient(500px 500px at 50% 80%, rgba(255,111,177,.10), transparent 60%),
        rgba(0,0,0,.18);
      box-shadow: 0 22px 60px rgba(0,0,0,.45);
      overflow:hidden;
      position:relative;
    }
    .cover img{
      width:100%;
      height:100%;
      object-fit:contain;
      filter: drop-shadow(0 28px 55px rgba(0,0,0,.35));
    }

    /* æ¨™é¡Œ */
    .meta{
      padding: 0 18px 4px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-size: 34px;
      font-weight: 860;
      letter-spacing:.5px;
      text-shadow: 0 18px 50px rgba(0,0,0,.35);
    }
    .pinkHeart{color: rgba(255,140,190,.95); font-size: 28px; position:relative; top:2px;}

    /* è·³å­—è¨Šæ¯ */
    .msg{
      padding: 0 18px 10px;
      display:flex;
      justify-content:center;
      color: var(--muted);
      font-size: 13.5px;
      min-height: 22px;
    }
    .popline{display:inline-block; white-space:pre-wrap}
    .ch{
      display:inline-block;
      transform: translateY(10px) scale(.98);
      opacity:0;
      filter: blur(1px);
      animation: pop .55s ease forwards;
    }
    @keyframes pop{
      to{transform: translateY(0) scale(1); opacity:1; filter: blur(0)}
    }

    /* é€²åº¦æ¢ */
    .barRow{
      padding: 0 18px 12px;
      display:flex;
      align-items:center;
      gap:12px;
      color: rgba(255,255,255,.78);
      font-size: 14px;
    }
    .range{
      flex:1;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,.18);
      position:relative;
      overflow:hidden;
    }
    .fill{
      position:absolute; left:0; top:0; bottom:0;
      width:0%;
      background: linear-gradient(90deg, rgba(255,255,255,.85), rgba(255,140,190,.9));
    }
    input[type="range"]{
      width:100%;
      appearance:none;
      background: transparent;
      position:relative;
      z-index:2;
      height: 26px;
      margin:-10px 0;
    }
    input[type="range"]::-webkit-slider-thumb{
      appearance:none;
      width:16px; height:16px;
      border-radius:999px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.15);
      box-shadow: 0 10px 22px rgba(0,0,0,.30);
      cursor:pointer;
    }

    /* æ§åˆ¶åˆ— */
    .controls{
      padding: 0 18px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .iconBtn{
      width:44px; height:44px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,.85);
      cursor:pointer;
      user-select:none;
    }
    .playBtn{
      width:74px; height:74px;
      border-radius:999px;
      border:0;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.65), rgba(255,111,177,.95));
      box-shadow: 0 20px 50px rgba(255,111,177,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .playTri{
      width:0;height:0;
      border-left:18px solid rgba(255,255,255,.92);
      border-top:12px solid transparent;
      border-bottom:12px solid transparent;
      margin-left:4px;
    }
    .pauseBars{
      display:none;
      gap:8px;
    }
    .pauseBars span{
      width:8px; height:26px;
      border-radius:6px;
      background: rgba(255,255,255,.92);
      display:block;
    }
    .isPlaying .playTri{display:none;}
    .isPlaying .pauseBars{display:flex;}

    /* å­—å¹• */
    .capWrap{
      margin: 0 18px 18px;
      padding: 12px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
    }
    .capTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      color: rgba(255,255,255,.72);
      font-size: 12.5px;
      margin-bottom:8px;
    }
    .caps{
      min-height: 84px;
      font-size: 16px;
      line-height: 1.9;
      text-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .capLine{
      opacity:.40;
      transform: translateY(0);
      transition: opacity .12s ease, transform .12s ease;
      white-space:pre-wrap;
    }
    .capLine.active{
      opacity:1;
      transform: translateY(-1px);
    }
    .hint{
      padding: 0 18px 18px;
      text-align:center;
      font-size: 12.5px;
      color: rgba(255,255,255,.62);
    }
  </style>
</head>

<body>
  <!-- èƒŒæ™¯ç²’å­ -->
  <div class="bg" id="bg"></div>

  <!-- å…©å¼µåœ–äº‚è·‘ -->
  <div class="playfield" id="playfield">
    <img class="runner bob" id="r1" src="img/run1.png" alt="">
    <img class="runner bob" id="r2" src="img/run2.png" alt="">
  </div>

  <div class="wrap" id="wrap">
    <div class="card">
      <div class="topText">
        <span>å¯¶å¯¶æˆ‘æ„›ä½ </span>
        <span class="smallHeart"></span>
      </div>

      <div class="coverWrap">
        <div class="cover">
          <img src="img/cover.png" alt="">
        </div>
      </div>

      <div class="meta">
        <span id="songTitle">Sweet Moment</span>
        <span class="pinkHeart">â™¥</span>
      </div>

      <div class="msg" id="msg"></div>

      <div class="barRow">
        <span id="tNow">0:00</span>
        <div class="range">
          <div class="fill" id="fill"></div>
          <input id="seek" type="range" min="0" max="1000" value="0" />
        </div>
        <span id="tAll">0:00</span>
      </div>

      <div class="controls">
        <div class="iconBtn" id="muteBtn" title="éœéŸ³/å–æ¶ˆéœéŸ³">ğŸ”ˆ</div>
        

        <button class="playBtn" id="playBtn" title="æ’­æ”¾/æš«åœ">
          <div class="playTri"></div>
          <div class="pauseBars"><span></span><span></span></div>
        </button>

        
        <div class="iconBtn" id="reloadBtn" title="é‡æ–°åˆ¤æ–·æ™‚é–“ä¸¦è¼‰å…¥">âŸ³</div>
      </div>

      <div class="capWrap" id="capWrap">
        <div class="capTop">
          <span>å­—å¹•</span>
          <span id="timeTag">00:00</span>
        </div>
        <div class="caps" id="caps"></div>
      </div>

      <div class="hint">å¯¶å¯¶è¦æŒ‰æ’­æ”¾å–”!!</div>

      <!-- çœŸæ­£æ’­æ”¾ç”¨çš„ audioï¼ˆéš±è—ï¼‰ -->
      <audio id="player" preload="auto"></audio>
    </div>
  </div>

<script>
  /** ====== 1) ä½ å¯è‡ªè¨‚ï¼šæ­Œå/è¨Šæ¯/å­—å¹•/è·¯å¾‘ ====== */
  const CFG = {
    slots: {
      morning: {
        label: "æ—©ä¸Š",
        title: "å¯¶å¯¶èµ·åºŠä¹‹æ­Œ",
        message: "ä»Šå¤©æ…¢æ…¢ä¾†ï¼Œæˆ‘åœ¨ä½ èº«é‚Šã€‚",
        song: "audio/Morning_song.mp3",
        captions: [
          { t: 10,  text: "æ—©ä¸Šçš„é¢¨ æœ‰ä¸€é»æ¶¼" },
          { t: 15,  text: "çª—å¤–çš„å…‰ æ…¢æ…¢äº®" },
          { t: 20, text: "ä¸ç”¨å¤ªå¿« ä¹Ÿä¸ç”¨è¶•" },
          { t: 26, text: "ä»Šå¤©çš„è·¯ æ…¢æ…¢èµ°å®Œ" },
          { t: 31, text: "å¦‚æœå¦³ç¬‘ é‚£å°±å¾ˆå¥½" },
          { t: 38, text: "æˆ‘åœ¨é€™è£¡ é™ªå¦³èµ·åºŠ" }
        ]
      },
      day: {
        label: "ç™½å¤©",
        title: "æˆ‘çš„è‡­å¯¶å¯¶",
        message: "ä¸Šç­å¾ˆè¾›è‹¦ï¼Œèƒ½ä¸Šå°±ä¸Šï¼›ç„¡èŠå°±åƒåƒå–å–ã€‚æœ‰æˆ‘é™ªä½ ã€‚",
        song: "audio/day_song.mp3",
        captions: [
          { t: 10,  text: "ä¸Šç­å¾ˆè¾›è‹¦" },
          { t: 12,  text: "èƒ½æ’å°±æ’" },
          { t: 14,  text: "ä¸æƒ³æ’çš„æ™‚å€™ ä¹Ÿæ²’é—œä¿‚" },
          { t: 21, text: "äº‹æƒ…åšå®Œ å°±å…ˆæ”¾è‘—" },
          { t: 25, text: "ç„¡èŠçš„è©± åƒåƒå–å–" },
          { t: 31, text: "ä¸ç”¨æƒ³å¤ªå¤š ä¹Ÿä¸ç”¨æ€¥" },
          { t: 38, text: "æœ‰æˆ‘é™ªä½  æ…¢æ…¢éå»" }
        ]
      },
      evening: {
        label: "æ™šä¸Š",
        title: "Good Job Today",
        message: "è¾›è‹¦äº†ï¼Œä»Šå¤©å°±åˆ°é€™è£¡ã€‚",
        song: "audio/day_song.mp3",
        captions: [
          { t: 0,  text: "ä»Šå¤©åšå¾—å¾ˆå¥½" },
          { t: 7,  text: "æŠŠç´¯æ”¾ä¸‹ä¾†" },
          { t: 14, text: "ä½ åªè¦è¢«æˆ‘å¥½å¥½é™ªè‘—" },
          { t: 20, text: "å°±å¤ äº†" }
        ]
      },
      night: {
        label: "æ·±å¤œ",
        title: "Iâ€™m Here",
        message: "å¦‚æœä½ é‚„é†’è‘—ï¼Œæˆ‘åœ¨ã€‚",
        song: "audio/day_song.mp3",
        captions: [
          { t: 0,  text: "å¦‚æœä½ é‚„é†’è‘—" },
          { t: 6,  text: "é‚£ä¹Ÿæ²’é—œä¿‚" },
          { t: 12, text: "å¤œå¾ˆé•·ï¼Œä½†æˆ‘åœ¨" },
          { t: 18, text: "æˆ‘å€‘ä¸€èµ·æ…¢æ…¢ç¡" }
        ]
      }
    }
  };

  /** ====== 2) å°å·¥å…· ====== */
  const $ = (id)=>document.getElementById(id);
  function pickSlotKey(){
    const h = new Date().getHours();
    if(h>=6 && h<11) return "morning";
    if(h>=11 && h<18) return "day";
    if(h>=18 && h<23) return "evening";
    return "night";
  }
  function fmt(sec){
    sec = Math.max(0, Math.floor(sec||0));
    const m = Math.floor(sec/60);
    const s = sec%60;
    return `${m}:${String(s).padStart(2,"0")}`;
  }
  function fmt2(sec){
    sec = Math.max(0, Math.floor(sec||0));
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
  }

  /** ====== 3) èƒŒæ™¯ç²’å­ç”Ÿæˆ ====== */
  const bg = $("bg");
  function spawnBackground(){
    // æ˜Ÿå…‰
    for(let i=0;i<26;i++){
      const s=document.createElement("div");
      s.className="spark";
      s.style.left = (Math.random()*100)+"vw";
      s.style.top  = (Math.random()*100)+"vh";
      s.style.animationDelay = (Math.random()*2.8)+"s";
      s.style.opacity = (0.25 + Math.random()*0.6);
      const size = 3 + Math.random()*5;
      s.style.width = size+"px";
      s.style.height = size+"px";
      bg.appendChild(s);
    }
    // æ¼‚æµ®æ„›å¿ƒï¼ˆèƒŒæ™¯ï¼‰
    for(let i=0;i<10;i++){
      const h=document.createElement("div");
      h.className="heart";
      h.style.left = (Math.random()*100)+"vw";
      h.style.bottom = (-40 - Math.random()*200)+"px";
      h.style.opacity = (0.20 + Math.random()*0.5);
      const scale = 0.6 + Math.random()*1.0;
      h.style.transform = `rotate(45deg) scale(${scale})`;
      const dur = 7 + Math.random()*9;
      h.style.animationDuration = dur+"s";
      h.style.animationDelay = (Math.random()*6)+"s";
      bg.appendChild(h);
    }
  }
  spawnBackground();

  /** ====== 4) DOM/ç‹€æ…‹ ====== */
  const wrap = $("wrap");
  const player = $("player");
  const playBtn = $("playBtn");
  const muteBtn = $("muteBtn");
  const prevBtn = $("prevBtn");
  const nextBtn = $("nextBtn");
  const reloadBtn = $("reloadBtn");
  const seek = $("seek");
  const fill = $("fill");
  const tNow = $("tNow");
  const tAll = $("tAll");
  const timeTag = $("timeTag");
  const songTitle = $("songTitle");
  const msgEl = $("msg");
  const capsEl = $("caps");
  const capWrap = $("capWrap");

  let slotKey = pickSlotKey();
  let slot = CFG.slots[slotKey];
  let duration = 0;
  let isSeeking = false;

  // è·³å­—å‹•ç•«
  function animateText(el, text){
    el.innerHTML = "";
    const span=document.createElement("span");
    span.className="popline";
    Array.from(text).forEach((c,i)=>{
      const s=document.createElement("span");
      s.className="ch";
      s.style.animationDelay = (i*0.03)+"s";
      s.textContent=c;
      span.appendChild(s);
    });
    el.appendChild(span);
  }

  // å­—å¹•æ¸²æŸ“
  function renderCaptions(captions){
    capsEl.innerHTML = "";
    (captions||[]).forEach((c,i)=>{
      const div=document.createElement("div");
      div.className="capLine";
      div.dataset.i=String(i);
      div.textContent=c.text;
      capsEl.appendChild(div);
    });
  }
  function activeIndex(captions, t){
    let a=-1;
    for(let i=0;i<captions.length;i++){
      if(t >= captions[i].t) a=i;
      else break;
    }
    return a;
  }

  /** ====== 5) è¼‰å…¥/åˆ‡æ­Œ ====== */
  function apply(key){
    slotKey = key;
    slot = CFG.slots[slotKey];

    songTitle.textContent = slot.title || "Sweet Moment";
    animateText(msgEl, slot.message || "");

    player.pause();
    player.currentTime = 0;
    player.src = slot.song || "";
    wrap.classList.remove("isPlaying");
    document.body.classList.add("paused");

    renderCaptions(slot.captions || []);
    timeTag.textContent = "00:00";

    // é€²åº¦æ­¸é›¶
    fill.style.width = "0%";
    seek.value = "0";
    tNow.textContent = "0:00";
    tAll.textContent = "0:00";
    duration = 0;
  }

  function keyOrder(){
    return ["morning","day","evening","night"];
  }
  function prevKey(){
    const arr=keyOrder();
    const i=arr.indexOf(slotKey);
    return arr[(i-1+arr.length)%arr.length];
  }
  function nextKey(){
    const arr=keyOrder();
    const i=arr.indexOf(slotKey);
    return arr[(i+1)%arr.length];
  }

  apply(slotKey);

  /** ====== 6) æ’­æ”¾/æš«åœ + éŸ³è¨Šåˆ†æï¼ˆç¯€å¥è·³ï¼‰ ====== */
  let audioCtx = null;
  let analyser = null;
  let data = null;
  let beat = 0; // 0~1

  function ensureAnalyser(){
    if(audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioCtx.createMediaElementSource(player);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 1024;
    data = new Uint8Array(analyser.fftSize);
    src.connect(analyser);
    analyser.connect(audioCtx.destination);
  }

  function updateBeat(){
    if(!analyser || !data) { beat = beat*0.85; return; }
    analyser.getByteTimeDomainData(data);
    let sum = 0;
    for(let i=0;i<data.length;i++){
      const v = (data[i]-128)/128;
      sum += v*v;
    }
    const rms = Math.sqrt(sum/data.length); // 0~1
    // å¹³æ»‘ï¼‹æ”¾å¤§æ„Ÿ
    beat = Math.min(1, beat*0.82 + rms*1.05);
  }

  async function togglePlay(){
    try{
      ensureAnalyser();
      if(audioCtx && audioCtx.state === "suspended") await audioCtx.resume();

      if(player.paused){
        await player.play();
        wrap.classList.add("isPlaying");
        document.body.classList.remove("paused");
      }else{
        player.pause();
        wrap.classList.remove("isPlaying");
        document.body.classList.add("paused");
      }
    }catch{
      // å¸¸è¦‹ï¼šæª”æ¡ˆä¸å­˜åœ¨/è·¯å¾‘éŒ¯
      alert("æ’­æ”¾å¤±æ•—ï¼šè«‹ç¢ºèªéŸ³æª”è·¯å¾‘æ­£ç¢ºï¼ˆä¾‹å¦‚ audio/day_song.mp3ï¼‰ä¸”æª”åå¤§å°å¯«ä¸€è‡´ã€‚");
    }
  }

  playBtn.addEventListener("click", togglePlay);
  player.addEventListener("play", ()=>{
    wrap.classList.add("isPlaying");
    document.body.classList.remove("paused");
  });
  player.addEventListener("pause", ()=>{
    wrap.classList.remove("isPlaying");
    document.body.classList.add("paused");
  });

  muteBtn.addEventListener("click", ()=>{
    player.muted = !player.muted;
    muteBtn.textContent = player.muted ? "ğŸ”‡" : "ğŸ”ˆ";
  });

  prevBtn.addEventListener("click", ()=>apply(prevKey()));
  nextBtn.addEventListener("click", ()=>apply(nextKey()));
  reloadBtn.addEventListener("click", ()=>apply(pickSlotKey()));

  /** ====== 7) é€²åº¦æ¢ï¼ˆå¯æ‹–æ›³ï¼‰ ====== */
  seek.addEventListener("pointerdown", ()=>{ isSeeking=true; });
  seek.addEventListener("pointerup", ()=>{ isSeeking=false; });
  seek.addEventListener("input", ()=>{
    if(!duration) return;
    const p = Number(seek.value)/1000;
    fill.style.width = (p*100)+"%";
    if(isSeeking){
      const t = p*duration;
      tNow.textContent = fmt(t);
      timeTag.textContent = fmt2(t);
    }
  });
  seek.addEventListener("change", ()=>{
    if(!duration) return;
    const p = Number(seek.value)/1000;
    player.currentTime = p*duration;
  });

  player.addEventListener("loadedmetadata", ()=>{
    duration = player.duration || 0;
    tAll.textContent = fmt(duration);
  });

  /** ====== 8) å­—å¹•è·Ÿéš¨ + è§’è‰²é è¿‘å­—å¹•ï¼ˆDï¼‰ ====== */
  let lastActive = -2;

  function updateCaptions(t){
    const caps = slot.captions || [];
    if(!caps.length){
      timeTag.textContent = fmt2(t);
      return;
    }
    const a = activeIndex(caps, t);
    const nodes = capsEl.querySelectorAll(".capLine");
    nodes.forEach((n,i)=>{
      n.classList.toggle("active", i===a);
      // åªé¡¯ç¤ºé™„è¿‘å¹¾è¡Œï¼ˆåƒæ’­æ”¾å™¨å­—å¹•ï¼‰
      if(a === -1) n.style.display = (i < 4 ? "" : "none");
      else n.style.display = (Math.abs(i-a)<=2 ? "" : "none");
    });
    timeTag.textContent = fmt2(t);

    // å­—å¹•æ›è¡Œ â†’ è®“å…©éš»é è¿‘å­—å¹•å€ã€åƒæŒ‡ä¸€ä¸‹ï¼ˆDï¼‰
    if(a !== lastActive){
      lastActive = a;
      attractToCaptionArea();
    }
  }

  /** ====== 9) å…©å¼µåœ–äº‚è·‘ï¼ˆA/B/C/Dï¼‰ ====== */
  const field = $("playfield");
  const r1 = $("r1");
  const r2 = $("r2");

  function makeRunner(el, seed){
    return {
      el,
      x: 70 + seed*90,
      y: 120 + seed*120,
      vx: (1.4 + Math.random()*1.6) * (Math.random()>.5?1:-1),
      vy: (1.2 + Math.random()*1.4) * (Math.random()>.5?1:-1),
      baseScale: 0.62 + Math.random()*0.10,
      lastSwitch: performance.now(),
      switchEvery: 1200 + Math.random()*1700,
      attractUntil: 0,
      attractX: 0,
      attractY: 0
    };
  }

  const R = [makeRunner(r1,1), makeRunner(r2,2)];

  function setRunnerTransform(s){
    // Aï¼šè·Ÿç¯€å¥è·³ï¼ˆbeat å½±éŸ¿ scaleï¼‰
    const pulse = 1 + (wrap.classList.contains("isPlaying") ? (beat*0.18) : 0);
    const sc = s.baseScale * pulse;

    // æ–¹å‘ç¿»è½‰ï¼ˆçœ‹èµ·ä¾†åœ¨è·‘ï¼‰
    s.el.classList.toggle("flip", s.vx < 0);

    s.el.style.transform = `translate3d(${s.x}px, ${s.y}px, 0) scale(${sc})`;
  }

  // Cï¼šé»æ“Šå™´æ„›å¿ƒ + æŠ–ä¸€ä¸‹
  function burstHearts(x, y){
    const n = 10 + Math.floor(Math.random()*10);
    for(let i=0;i<n;i++){
      const h = document.createElement("div");
      h.className = "heart";
      h.style.left = (x + (Math.random()*60-30)) + "px";
      h.style.top  = (y + (Math.random()*60-30)) + "px";
      const scale = 0.45 + Math.random()*0.9;
      h.style.transform = `rotate(45deg) scale(${scale})`;
      const dur = 0.9 + Math.random()*1.2;
      h.style.animationDuration = dur+"s";
      h.style.animationDelay = "0s";
      h.style.opacity = 0.75;

      // æ”¹æˆã€Œå¾€ä¸Šå™´ã€çš„å°ç²’å­ï¼ˆç”¨ floatUp ä¹Ÿå¯ï¼‰
      // ç›´æ¥ç”¨ floatUpï¼šå¾ top é–‹å§‹å¾€ä¸Šæœƒæ€ªï¼Œå› æ­¤æŠŠ bottom æ”¹ç”¨ translate æ–¹æ¡ˆ
      // ç°¡åŒ–ï¼šç”¨ CSS floatUpï¼ˆä¸Šå‡ï¼‰ï¼Œèµ·é»ä»¥ top æ–¹å¼é¡¯ç¤ºä»å¯æ¥å—
      bg.appendChild(h);

      // è‡ªå‹•æ¸…æ‰
      setTimeout(()=>h.remove(), 2200);
    }
  }

  function shake(el){
    el.classList.remove("shake");
    // é‡æ–°è§¸ç™¼
    void el.offsetWidth;
    el.classList.add("shake");
    setTimeout(()=>el.classList.remove("shake"), 280);
  }

  r1.addEventListener("click", (e)=>{
    shake(r1);
    burstHearts(e.clientX, e.clientY);
  });
  r2.addEventListener("click", (e)=>{
    shake(r2);
    burstHearts(e.clientX, e.clientY);
  });

  // Dï¼šå­—å¹•è®ŠåŒ–æ™‚ï¼ŒçŸ­æš«å¸å¼•åˆ°å­—å¹•å€
  function attractToCaptionArea(){
    const rect = capWrap.getBoundingClientRect();
    // ç›®æ¨™é»ï¼šå­—å¹•æ¡†ä¸­é–“åä¸Š
    const tx = rect.left + rect.width*0.35;
    const ty = rect.top  + rect.height*0.35;

    const now = performance.now();
    R.forEach((s, idx)=>{
      s.attractUntil = now + (700 + idx*180);
      s.attractX = tx + (idx===0 ? -70 : 70);
      s.attractY = ty + (idx===0 ? -10 : 15);
    });
  }

  // åˆæ¬¡ä¹Ÿå¸ä¸€æ¬¡ï¼ˆè®“å®ƒå€‘æ‡‚å­—å¹•ä½ç½®ï¼‰
  setTimeout(attractToCaptionArea, 500);

  function tick(now){
    // Aï¼šç¯€å¥åˆ†ææ›´æ–°
    updateBeat();

    // é€²åº¦/å­—å¹•æ›´æ–°
    const t = player.currentTime || 0;
    if(duration > 0){
      const p = Math.min(1, t/duration);
      if(!isSeeking){
        seek.value = String(Math.floor(p*1000));
        fill.style.width = (p*100)+"%";
        tNow.textContent = fmt(t);
      }
    }else{
      tNow.textContent = fmt(t);
    }
    updateCaptions(t);

    // Bï¼šæ’­æ”¾æ‰è·‘ï¼Œæš«åœå°±åœï¼ˆåœæ­¢æ›´æ–°ä½ç½®ï¼‰
    const playing = wrap.classList.contains("isPlaying");

    const w = window.innerWidth;
    const h = window.innerHeight;

    R.forEach((s)=>{
      if(playing){
        // å¶çˆ¾éš¨æ©Ÿè®Šé€Ÿ/è½‰å‘ï¼ˆæ›´åƒäº‚è·‘ï¼‰
        if(now - s.lastSwitch > s.switchEvery){
          s.vx += (Math.random()*1.2 - 0.6);
          s.vy += (Math.random()*1.0 - 0.5);
          s.vx = Math.max(-3.2, Math.min(3.2, s.vx));
          s.vy = Math.max(-3.0, Math.min(3.0, s.vy));
          s.lastSwitch = now;
          s.switchEvery = 1200 + Math.random()*1800;
        }

        // Dï¼šå­—å¹•å¸å¼•ï¼ˆçŸ­æ™‚é–“ï¼‰
        if(now < s.attractUntil){
          const ax = s.attractX - s.x;
          const ay = s.attractY - s.y;
          s.vx += ax * 0.0006;
          s.vy += ay * 0.0006;
        }

        s.x += s.vx;
        s.y += s.vy;

        // é‚Šç•Œç¢°æ’åå½ˆ
        const rectW = s.el.getBoundingClientRect().width;
        const rectH = s.el.getBoundingClientRect().height;
        const minX = 10, minY = 10;
        const maxX = w - rectW - 10;
        const maxY = h - rectH - 10;

        if(s.x < minX){ s.x = minX; s.vx *= -1; }
        if(s.x > maxX){ s.x = maxX; s.vx *= -1; }
        if(s.y < minY){ s.y = minY; s.vy *= -1; }
        if(s.y > maxY){ s.y = maxY; s.vy *= -1; }
      }

      setRunnerTransform(s);
    });

    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
</script>
</body>
</html>
